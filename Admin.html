<html>
<head>
    <title>Employee Leave Tracker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f5f7;
            margin: 0;
            padding: 0px;
        }

        #nav {
            background: #1e88e5;
            padding: 15px 0;
            margin-bottom: 40px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .deco {
            text-decoration: none;
            color: white;
            font-size: 20px;
            margin: 0 25px;
            font-weight: 500;
            transition: 0.3s ease;
        }

        .deco:hover {
            color: #ffeb3b;
        }

        table, th, td {
            border: 1px solid #ddd;
            border-collapse: collapse;
        }

        table {
            width: 90%;
            margin: 15px auto;
            background: white;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }

        thead {
            background: #b5e1ff;
            color: #37474f;
            font-weight: 600;
        }

        th, td {
            padding: 12px;
            text-align: center;
        }

        #filters {
            display: flex;
            flex-direction: column;   
            gap: 12px;
            background: white;
            padding: 16px 20px;
            width: fit-content;
            margin: 20px auto;
            border-radius: 6px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            font-weight: bold;
        }


        select, input[type="search"], textarea {
            padding: 8px;
            border: 1px solid #bbb;
            border-radius: 4px;
            font-size: 14px;
        }

        button, 
        input[type="submit"] {
            padding: 8px 14px;
            background: #1e88e5;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: 0.3s ease;
        }

        button:hover, 
        input[type="submit"]:hover {
            background: #1565c0;
        }

        table button {
            background: #d9534f;
        }

        table button:hover {
            background: #c9302c;
        }

        #statustype {
            display: none;
        }

        .pendingcolor { background-color: #fff4b3; }
        .approvedcolor { background-color: #c9f7d5; }
        .rejectedcolor { background-color: #ffcccc; }
        .sickcolor { background-color: #ffe0e0; }
        .casualcolor { background-color: #eef0ff; }
        .earnedcolor { background-color: #e8ffe8; }
        .emergencycolor { background-color: #ffe9d6; }

        textarea {
            resize: vertical;
            width: 100%;
            min-height: 50px;
            font-family: Arial, sans-serif;
        }

        .group-heading {
            background-color: #1e88e5;
            color: white;
            font-weight: bold;
            text-align: left;
            padding: 6px 12px;
        }
    </style>
</head>
<body>
    <div id="nav">
        <center>
            <a href="Admin.html" class="deco">Employee Leave Tracker</a>
            <a href="addemployee.html" class="deco">Add Employee</a>
            <a href="employeedetails.html" class="deco">Employee Details</a>
        </center>
    </div>

    <table>
        <thead>
            <tr>
                <th>Total Requests</th>
                <th>Pending</th>
                <th>Approved</th>
                <th>Rejected</th>
            </tr>
        </thead>
        <tbody style="text-align: center;">
            <tr>
                <td id="reqcount">0</td>
                <td id="pencount">0</td>
                <td id="appcount">0</td>
                <td id="rejcount">0</td>
            </tr>
        </tbody>
    </table>

    <div id="filters">
        <div>
            Filter
            <select id="filter" onchange="changetype()">
                <option value="leavetype">Leave Type</option>
                <option value="status">Status</option>
            </select> 
            by 
            <select id="leavetype">
                <option value="All">All</option>
                <option value="Sick">Sick</option>
                <option value="Casual">Casual</option>
                <option value="Earned">Earned</option>
                <option value="Emergency">Emergency</option>
            </select>
            <select id="statustype">
                <option value="All">All</option>
                <option value="Pending">Pending</option>
                <option value="Approved">Approved</option>
                <option value="Rejected">Rejected</option>
            </select>
            <button onclick="applyfilter()">Apply Filter</button>
        </div>

        <center>
            <div>
                Group by 
                <select id="groupby">
                    <option value="none">None</option>
                    <option value="employee">Employee</option>
                    <option value="department">Department</option>
                </select>
                <button onclick="applygrouping()">Apply Group</button>
            </div>
        </center>

    </div>

    <center>
        <input id="searchtext" type="search"/>
        <input type="submit" value="Search" onclick="search()"/>
    </center>

    <table id="table">
        <thead>
            <tr>
                <th>Emp ID</th>
                <th>Name</th>
                <th>Department</th>
                <th>Leave Type</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>No.of Days</th>
                <th>Reason</th>
                <th>Status</th>
                <th>Comment</th>
                <th>Action</th>
                
            </tr>
        </thead>
        <tbody id="tbody"></tbody>
    </table>

<script>
function search(){
    let name=document.getElementById('searchtext').value;
    let arr=JSON.parse(localStorage.getItem('storedata'))||[];
    let filteredarr=arr.filter(item=>{
        let employees=JSON.parse(localStorage.getItem('storeempdetails'))||[];
        let emp=employees.find(e=>e.empid===item.empid);
        let empname = emp ? emp.name : "";
        return empname.toLowerCase().includes(name.toLowerCase());
    });
    document.getElementById('searchtext').value="";
    display(filteredarr);
}

function updatestatus(index,value){
    let arr=JSON.parse(localStorage.getItem('storedata'))||[];
    arr[index].status=value;

    if(value !== "Pending"){
        arr[index].comment = arr[index].comment || "";
    }

    localStorage.setItem('storedata',JSON.stringify(arr));
    display(arr);
}


function display(data, groupBy="none"){
    let tablebody = document.getElementById('tbody');
    let count = 0, pencount = 0, appcount = 0, rejcount = 0;
    let employees = JSON.parse(localStorage.getItem('storeempdetails')) || [];
    tablebody.innerHTML="";

    function addRow(item){
        let emp = employees.find(e => e.empid === item.empid) || {name:"-", dept:"-"};
        let start = new Date(item.startdate);
        let end = new Date(item.enddate);
        let days = (end - start) / (1000*60*60*24) + 1;
        let row = `
<tr>
    <td>${item.empid}</td>
    <td>${emp.name}</td>
    <td>${emp.dept}</td>
    <td class="${
        item.leavetype === 'Sick' ? 'sickcolor' :
        item.leavetype === 'Casual' ? 'casualcolor' :
        item.leavetype === 'Earned' ? 'earnedcolor' :
        'emergencycolor'
    }">${item.leavetype}</td>
    <td>${item.startdate}</td>
    <td>${item.enddate}</td>
    <td>${days}</td>
    <td>${item.reason || ""}</td> <!-- moved here -->
    <td class="${
        item.status === 'Pending' ? 'pendingcolor' :
        item.status === 'Approved' ? 'approvedcolor' :
        'rejectedcolor'
    }">
        ${item.status === "Pending" ? `<select onchange="updatestatus(${data.indexOf(item)}, this.value)">
            <option value="Pending">Pending</option>
            <option value="Approved">Approved</option>
            <option value="Rejected">Rejected</option>
        </select>` : item.status}
    </td>
    <td>
    ${
        item.status === "Pending"
        ? `<textarea 
                placeholder="Enter comment..."
                onchange="updateComment(${data.indexOf(item)}, this.value)"
          >${item.comment || ""}</textarea>`
        : (item.comment || "-")
    }
</td>

    <td><button onclick="deleterow(${data.indexOf(item)})">Delete</button></td>
</tr>
`;

        tablebody.innerHTML += row;
    }

    function updateCounts(item){
        count++;
        if(item.status==='Pending') pencount++;
        if(item.status==='Approved') appcount++;
        if(item.status==='Rejected') rejcount++;
    }

    if(groupBy === "employee"){
        let grouped = {};
        data.forEach(item => {
            grouped[item.empid] = grouped[item.empid] || [];
            grouped[item.empid].push(item);
        });
        for(let empid in grouped){
            let emp = employees.find(e => e.empid === empid) || {name:"-", dept:"-"};
            tablebody.innerHTML += `<tr class="group-heading"><td colspan="11">Employee: ${emp.name} (${empid})</td></tr>`;
            grouped[empid].forEach(item => {
                addRow(item);
                updateCounts(item);
            });
        }
    } else if(groupBy === "department"){
        let grouped = {};
        data.forEach(item => {
            let dept = (employees.find(e => e.empid===item.empid)||{dept:'-'}).dept;
            grouped[dept] = grouped[dept] || [];
            grouped[dept].push(item);
        });
        for(let dept in grouped){
            tablebody.innerHTML += `<tr class="group-heading"><td colspan="11">Department: ${dept}</td></tr>`;
            grouped[dept].forEach(item => {
                addRow(item);
                updateCounts(item);
            });
        }
    } else {
        data.forEach(item => {
            addRow(item);
            updateCounts(item);
        });
    }

    document.getElementById('reqcount').innerText=count;
    document.getElementById('pencount').innerText=pencount;
    document.getElementById('appcount').innerText=appcount;
    document.getElementById('rejcount').innerText=rejcount;
}

function updateComment(index, value){
        let arr = JSON.parse(localStorage.getItem('storedata')) || [];
        arr[index].comment = value;
        localStorage.setItem('storedata', JSON.stringify(arr));
    }

function changetype(){
    let type=document.getElementById('filter').value;
    document.getElementById('statustype').style.display = (type === "status") ? 'block' : 'none';
    document.getElementById('leavetype').style.display = (type === "leavetype") ? 'block' : 'none';
}

function applyfilter(){
    let arr=JSON.parse(localStorage.getItem('storedata'))||[];
    let filtertype=document.getElementById('filter').value;
    let selectedvalue = (filtertype==='leavetype') ? document.getElementById('leavetype').value : document.getElementById('statustype').value;

    if(selectedvalue==='All') display(arr);
    else{
        let filteredarr = arr.filter(item=> filtertype==='leavetype' ? item.leavetype===selectedvalue : item.status===selectedvalue);
        display(filteredarr);
    }
}

function applygrouping(){
    let arr = JSON.parse(localStorage.getItem('storedata')) || [];
    display(arr, document.getElementById('groupby').value);
}

function deleterow(index){
    let arr=JSON.parse(localStorage.getItem('storedata'))||[];
    arr.splice(index,1);
    localStorage.setItem('storedata',JSON.stringify(arr));
    display(arr);
}

function load(){
    let arr=JSON.parse(localStorage.getItem('storedata'))||[];
    display(arr);
}
load();
</script>
</body>
</html>
